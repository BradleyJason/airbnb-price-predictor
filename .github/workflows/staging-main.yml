name: staging → main (Production deployment)

on:
  push:
    branches:
      - main

env:
  DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
  DAGSHUB_TOKEN:    ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

jobs:
  promote-to-production:
    name: Promote Staging model → Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Verify Staging model exists
        run: |
          python - <<'EOF'
          import os
          import sys
          import mlflow
          from mlflow.tracking import MlflowClient

          # Auth via env vars — no interactive OAuth
          os.environ["MLFLOW_TRACKING_USERNAME"] = os.environ["DAGSHUB_USERNAME"]
          os.environ["MLFLOW_TRACKING_PASSWORD"] = os.environ["DAGSHUB_TOKEN"]
          mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])

          client = MlflowClient()
          model_name = "airbnb-price-predictor"

          versions = client.search_model_versions(f"name='{model_name}'")
          staging  = [v for v in versions if v.current_stage == "Staging"]

          if not staging:
              print("ERROR: No model found at stage 'Staging'.")
              print("Run the dev → staging pipeline first.")
              sys.exit(1)

          latest = sorted(staging, key=lambda v: int(v.version))[-1]
          run    = client.get_run(latest.run_id)
          r2     = run.data.metrics.get("r2",  "N/A")
          mae    = run.data.metrics.get("mae", "N/A")

          print(f"Staging model found : v{latest.version} (run {latest.run_id[:8]})")
          print(f"  R²  : {r2}")
          print(f"  MAE : {mae}")
          print("Staging model verified — ready for promotion.")
          EOF

      - name: Promote Staging → Production
        run: |
          python - <<'EOF'
          import os
          import sys
          import mlflow
          from mlflow.tracking import MlflowClient

          # Auth via env vars — no interactive OAuth
          os.environ["MLFLOW_TRACKING_USERNAME"] = os.environ["DAGSHUB_USERNAME"]
          os.environ["MLFLOW_TRACKING_PASSWORD"] = os.environ["DAGSHUB_TOKEN"]
          mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])

          client = MlflowClient()
          model_name = "airbnb-price-predictor"

          versions = client.search_model_versions(f"name='{model_name}'")
          staging  = [v for v in versions if v.current_stage == "Staging"]
          latest   = sorted(staging, key=lambda v: int(v.version))[-1]

          client.transition_model_version_stage(
              name=model_name,
              version=latest.version,
              stage="Production",
              archive_existing_versions=True,
          )
          print(f"v{latest.version} promoted to Production.")
          EOF

  e2e-smoke-tests:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: promote-to-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run e2e smoke tests
        run: |
          pytest tests/e2e/ --tb=short -v

      - name: Deployment confirmed
        run: echo "Deployed to production"
