name: staging → main (Production deployment)

on:
  push:
    branches:
      - main

env:
  DAGSHUB_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
  DAGSHUB_TOKEN:    ${{ secrets.DAGSHUB_TOKEN }}
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}

jobs:
  promote-to-production:
    name: Promote candidate → champion
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Verify candidate alias exists
        run: |
          python - <<'EOF'
          import os
          import sys
          import mlflow
          from mlflow.tracking import MlflowClient

          # Auth via env vars — no interactive OAuth
          os.environ["MLFLOW_TRACKING_USERNAME"] = os.environ["DAGSHUB_USERNAME"]
          os.environ["MLFLOW_TRACKING_PASSWORD"] = os.environ["DAGSHUB_TOKEN"]
          mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])

          client = MlflowClient()
          model_name = "airbnb-price-predictor"

          try:
              candidate = client.get_model_version_by_alias(model_name, "candidate")
          except Exception:
              print("ERROR: No model found with alias 'candidate'.")
              print("Run the dev -> staging pipeline first.")
              sys.exit(1)

          run = client.get_run(candidate.run_id)
          r2  = run.data.metrics.get("r2",  "N/A")
          mae = run.data.metrics.get("mae", "N/A")

          print(f"Candidate model found : v{candidate.version} (run {candidate.run_id[:8]})")
          print(f"  R2  : {r2}")
          print(f"  MAE : {mae}")
          print("Candidate model verified — ready for promotion.")
          EOF

      - name: Assign champion alias
        run: |
          python - <<'EOF'
          import os
          import sys
          import mlflow
          from mlflow.tracking import MlflowClient

          # Auth via env vars — no interactive OAuth
          os.environ["MLFLOW_TRACKING_USERNAME"] = os.environ["DAGSHUB_USERNAME"]
          os.environ["MLFLOW_TRACKING_PASSWORD"] = os.environ["DAGSHUB_TOKEN"]
          mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])

          client = MlflowClient()
          model_name = "airbnb-price-predictor"

          candidate = client.get_model_version_by_alias(model_name, "candidate")
          client.set_registered_model_alias(
              name=model_name,
              alias="champion",
              version=candidate.version,
          )
          print(f"v{candidate.version} is now 'champion'.")
          EOF

  e2e-smoke-tests:
    name: E2E Smoke Tests
    runs-on: ubuntu-latest
    needs: promote-to-production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Run e2e smoke tests
        run: |
          pytest tests/e2e/ --tb=short -v

      - name: Deployment confirmed
        run: echo "Deployed to production"
